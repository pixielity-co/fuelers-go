# ─── Stage 1: Build ──────────────────────────────────────────
#
# Builds the <%= nameTitle %> service binary.
#
FROM golang:1.23-alpine AS builder

WORKDIR /app

# Copy the workspace configuration and shared packages
COPY go.work go.work
COPY packages/ ./packages/

# Copy this application's code
COPY apps/<%= name %> ./apps/<%= name %>/

# Download dependencies for the whole workspace (optimized for caching)
RUN go mod download

# Build the binary
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags="-w -s" \
    -o /bin/<%= name %> \
    ./apps/<%= name %>/src/main.go

# ─── Stage 2: Runtime ───────────────────────────────────────
FROM alpine:latest

# Install CA certificates for HTTPS and timezone data
RUN apk --no-cache add ca-certificates tzdata

WORKDIR /

COPY --from=builder /bin/<%= name %> /bin/<%= name %>

EXPOSE 8080

ENTRYPOINT ["/bin/<%= name %>"]
